<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Authentication Test - CapyCares</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .quick-links {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .quick-link {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
        }
        .quick-link:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <img src="images/Logo.png" alt="CapyCares Logo" class="logo-img">
            </div>
            <h1 class="logo-text">Auth Test Center</h1>
        </div>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="student-login.html">Student Login</a>
            <a href="admin-login.html">Admin Login</a>
            <a href="student-signup.html">Student Signup</a>
            <a href="admin-signup.html">Admin Signup</a>
        </nav>
    </header>

    <main class="container">
        <h1>üîê Complete Authentication System Test</h1>
        
        <div class="quick-links">
            <a href="student-login.html" class="quick-link">Student Login</a>
            <a href="admin-login.html" class="quick-link">Admin Login</a>
            <a href="student-signup.html" class="quick-link">Student Signup</a>
            <a href="admin-signup.html" class="quick-link">Admin Signup</a>
            <a href="debug-login.html" class="quick-link">Debug Login</a>
        </div>

        <div class="test-grid">
            <!-- Backend Status -->
            <div class="test-card">
                <h3>üì° Backend Connection</h3>
                <button onclick="testBackend()" class="btn">Test Connection</button>
                <div id="backendResult" class="test-result info">Click to test</div>
            </div>

            <!-- Database Status -->
            <div class="test-card">
                <h3>üóÑÔ∏è Database Status</h3>
                <button onclick="testDatabase()" class="btn">Check Database</button>
                <div id="databaseResult" class="test-result info">Click to check</div>
            </div>

            <!-- Student Login Test -->
            <div class="test-card">
                <h3>üéì Student Login</h3>
                <form id="studentLoginForm">
                    <div class="form-group">
                        <input type="email" id="studentEmail" class="form-input" placeholder="Email" value="kesh23csds@cmrit.ac.in">
                    </div>
                    <div class="form-group">
                        <input type="password" id="studentPass" class="form-input" placeholder="Password" value="Student123">
                    </div>
                    <button type="submit" class="btn">Test Login</button>
                </form>
                <div id="studentLoginResult" class="test-result info">Ready to test</div>
            </div>

            <!-- Admin Login Test -->
            <div class="test-card">
                <h3>üëë Admin Login</h3>
                <form id="adminLoginForm">
                    <div class="form-group">
                        <input type="email" id="adminEmail" class="form-input" placeholder="Email" value="admin@cmrit.ac.in">
                    </div>
                    <div class="form-group">
                        <input type="password" id="adminPass" class="form-input" placeholder="Password" value="Admin123">
                    </div>
                    <button type="submit" class="btn">Test Login</button>
                </form>
                <div id="adminLoginResult" class="test-result info">Ready to test</div>
            </div>

            <!-- Student Signup Test -->
            <div class="test-card">
                <h3>üéì Student Signup</h3>
                <form id="studentSignupForm">
                    <div class="form-group">
                        <input type="text" id="studentName" class="form-input" placeholder="Full Name" value="Test Student">
                    </div>
                    <div class="form-group">
                        <input type="email" id="studentSignupEmail" class="form-input" placeholder="Email" value="newstudent@cmrit.ac.in">
                    </div>
                    <div class="form-group">
                        <input type="password" id="studentSignupPass" class="form-input" placeholder="Password" value="Test1234">
                    </div>
                    <div class="form-group">
                        <input type="password" id="studentConfirmPass" class="form-input" placeholder="Confirm Password" value="Test1234">
                    </div>
                    <button type="submit" class="btn" style="background-color: #28a745;">Test Signup</button>
                </form>
                <div id="studentSignupResult" class="test-result info">Ready to test</div>
            </div>

            <!-- Admin Signup Test -->
            <div class="test-card">
                <h3>üëë Admin Signup</h3>
                <form id="adminSignupForm">
                    <div class="form-group">
                        <input type="text" id="adminName" class="form-input" placeholder="Full Name" value="Test Admin">
                    </div>
                    <div class="form-group">
                        <input type="email" id="adminSignupEmail" class="form-input" placeholder="Email" value="newadmin@cmrit.ac.in">
                    </div>
                    <div class="form-group">
                        <input type="password" id="adminSignupPass" class="form-input" placeholder="Password" value="Admin1234">
                    </div>
                    <div class="form-group">
                        <input type="password" id="adminConfirmPass" class="form-input" placeholder="Confirm Password" value="Admin1234">
                    </div>
                    <button type="submit" class="btn" style="background-color: #28a745;">Test Signup</button>
                </form>
                <div id="adminSignupResult" class="test-result info">Ready to test</div>
            </div>
        </div>

        <!-- Session Management -->
        <div class="test-card">
            <h3>üîí Current Session</h3>
            <div id="sessionStatus" class="test-result info">Checking...</div>
            <button onclick="clearSession()" class="btn" style="background-color: #dc3545;">Clear Session</button>
            <button onclick="refreshSession()" class="btn">Refresh Status</button>
        </div>

        <!-- Test Summary -->
        <div class="test-card">
            <h3>üìã Test Summary</h3>
            <div id="testSummary" class="test-result info">
                Run tests above to see results
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // Global test results tracking
        let testResults = {
            backend: null,
            database: null,
            studentLogin: null,
            adminLogin: null,
            studentSignup: null,
            adminSignup: null
        };

        // Test backend connection
        async function testBackend() {
            const resultDiv = document.getElementById('backendResult');
            try {
                const response = await fetch('http://localhost:5000/api/test-ping', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = '‚úÖ Backend is running and responsive';
                    resultDiv.className = 'test-result success';
                    testResults.backend = 'pass';
                } else {
                    resultDiv.innerHTML = '‚ö†Ô∏è Backend responded with status: ' + response.status;
                    resultDiv.className = 'test-result warning';
                    testResults.backend = 'warn';
                }
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Backend connection failed: ' + error.message;
                resultDiv.className = 'test-result error';
                testResults.backend = 'fail';
            }
            updateSummary();
        }

        // Test database connectivity
        async function testDatabase() {
            const resultDiv = document.getElementById('databaseResult');
            try {
                // Test with a simple auth endpoint
                const response = await fetch('http://localhost:5000/api/auth/student/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@cmrit.ac.in',
                        password: 'wrongpassword'
                    })
                });
                
                if (response.status === 401 || response.status === 400) {
                    resultDiv.innerHTML = '‚úÖ Database connected and responding';
                    resultDiv.className = 'test-result success';
                    testResults.database = 'pass';
                } else {
                    resultDiv.innerHTML = '‚ö†Ô∏è Unexpected response: ' + response.status;
                    resultDiv.className = 'test-result warning';
                    testResults.database = 'warn';
                }
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Database connection failed: ' + error.message;
                resultDiv.className = 'test-result error';
                testResults.database = 'fail';
            }
            updateSummary();
        }

        // Student login test
        document.getElementById('studentLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('studentLoginResult');
            const email = document.getElementById('studentEmail').value;
            const password = document.getElementById('studentPass').value;
            
            resultDiv.innerHTML = 'üîÑ Testing...';
            resultDiv.className = 'test-result info';
            
            try {
                await performStudentLogin(email, password);
                // Check if login was successful by checking local storage
                setTimeout(() => {
                    if (localStorage.getItem('userToken')) {
                        resultDiv.innerHTML = '‚úÖ Student login successful!';
                        resultDiv.className = 'test-result success';
                        testResults.studentLogin = 'pass';
                    } else {
                        resultDiv.innerHTML = '‚ùå Student login failed';
                        resultDiv.className = 'test-result error';
                        testResults.studentLogin = 'fail';
                    }
                    updateSummary();
                }, 1000);
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Student login error: ' + error.message;
                resultDiv.className = 'test-result error';
                testResults.studentLogin = 'fail';
                updateSummary();
            }
        });

        // Admin login test
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('adminLoginResult');
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPass').value;
            
            resultDiv.innerHTML = 'üîÑ Testing...';
            resultDiv.className = 'test-result info';
            
            try {
                await performAdminLogin(email, password);
                // Check if login was successful
                setTimeout(() => {
                    if (localStorage.getItem('userToken')) {
                        resultDiv.innerHTML = '‚úÖ Admin login successful!';
                        resultDiv.className = 'test-result success';
                        testResults.adminLogin = 'pass';
                    } else {
                        resultDiv.innerHTML = '‚ùå Admin login failed';
                        resultDiv.className = 'test-result error';
                        testResults.adminLogin = 'fail';
                    }
                    updateSummary();
                }, 1000);
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Admin login error: ' + error.message;
                resultDiv.className = 'test-result error';
                testResults.adminLogin = 'fail';
                updateSummary();
            }
        });

        // Student signup test
        document.getElementById('studentSignupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('studentSignupResult');
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentSignupEmail').value;
            const password = document.getElementById('studentSignupPass').value;
            const confirmPassword = document.getElementById('studentConfirmPass').value;
            
            resultDiv.innerHTML = 'üîÑ Testing...';
            resultDiv.className = 'test-result info';
            
            try {
                await performStudentSignup(name, email, password, confirmPassword);
                // Check if signup was successful
                setTimeout(() => {
                    if (localStorage.getItem('userToken')) {
                        resultDiv.innerHTML = '‚úÖ Student signup successful!';
                        resultDiv.className = 'test-result success';
                        testResults.studentSignup = 'pass';
                    } else {
                        // Check if it failed due to existing user
                        resultDiv.innerHTML = '‚ö†Ô∏è Student signup may have failed (check console)';
                        resultDiv.className = 'test-result warning';
                        testResults.studentSignup = 'warn';
                    }
                    updateSummary();
                }, 1500);
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Student signup error: ' + error.message;
                resultDiv.className = 'test-result error';
                testResults.studentSignup = 'fail';
                updateSummary();
            }
        });

        // Admin signup test
        document.getElementById('adminSignupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('adminSignupResult');
            const name = document.getElementById('adminName').value;
            const email = document.getElementById('adminSignupEmail').value;
            const password = document.getElementById('adminSignupPass').value;
            const confirmPassword = document.getElementById('adminConfirmPass').value;
            
            resultDiv.innerHTML = 'üîÑ Testing...';
            resultDiv.className = 'test-result info';
            
            try {
                await performAdminSignup(name, email, password, confirmPassword);
                // Check if signup was successful
                setTimeout(() => {
                    if (localStorage.getItem('userToken')) {
                        resultDiv.innerHTML = '‚úÖ Admin signup successful!';
                        resultDiv.className = 'test-result success';
                        testResults.adminSignup = 'pass';
                    } else {
                        resultDiv.innerHTML = '‚ö†Ô∏è Admin signup may have failed (check console)';
                        resultDiv.className = 'test-result warning';
                        testResults.adminSignup = 'warn';
                    }
                    updateSummary();
                }, 1500);
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Admin signup error: ' + error.message;
                resultDiv.className = 'test-result error';
                testResults.adminSignup = 'fail';
                updateSummary();
            }
        });

        // Session management
        function checkSession() {
            const sessionDiv = document.getElementById('sessionStatus');
            const token = localStorage.getItem('userToken');
            const userData = localStorage.getItem('userData');
            
            if (token && userData) {
                const user = JSON.parse(userData);
                sessionDiv.innerHTML = `‚úÖ Active session<br>
                    Role: ${user.role}<br>
                    Name: ${user.name}<br>
                    Email: ${user.email}<br>
                    Token: ${token.substring(0, 20)}...`;
                sessionDiv.className = 'test-result success';
            } else {
                sessionDiv.innerHTML = '‚ùå No active session';
                sessionDiv.className = 'test-result error';
            }
        }

        function clearSession() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userData');
            checkSession();
            // Reset all test results
            Object.keys(testResults).forEach(key => testResults[key] = null);
            updateSummary();
            
            document.querySelectorAll('.test-result').forEach(div => {
                if (!div.id.includes('Status')) {
                    div.innerHTML = 'Ready to test';
                    div.className = 'test-result info';
                }
            });
        }

        function refreshSession() {
            checkSession();
        }

        // Update test summary
        function updateSummary() {
            const summaryDiv = document.getElementById('testSummary');
            let passed = 0;
            let failed = 0;
            let warnings = 0;
            
            Object.values(testResults).forEach(result => {
                if (result === 'pass') passed++;
                else if (result === 'fail') failed++;
                else if (result === 'warn') warnings++;
            });
            
            const totalTests = Object.keys(testResults).length;
            const completedTests = Object.values(testResults).filter(r => r !== null).length;
            
            let summaryHTML = `
                Tests Completed: ${completedTests}/${totalTests}<br>
                Passed: ${passed} | Failed: ${failed} | Warnings: ${warnings}<br><br>
            `;
            
            if (completedTests > 0) {
                const percentage = Math.round((passed / completedTests) * 100);
                summaryHTML += `Success Rate: ${percentage}%`;
                
                if (percentage === 100) {
                    summaryDiv.className = 'test-result success';
                } else if (percentage >= 70) {
                    summaryDiv.className = 'test-result warning';
                } else {
                    summaryDiv.className = 'test-result error';
                }
            } else {
                summaryHTML += 'Run tests to see results';
                summaryDiv.className = 'test-result info';
            }
            
            summaryDiv.innerHTML = summaryHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            updateSummary();
        });
    </script>
</body>
</html>