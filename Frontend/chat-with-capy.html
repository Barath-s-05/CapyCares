<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Capy - CapyCares</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px 0;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #fe8400;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <!-- Logo placeholder - replace 'images/logo.png' with your logo -->
                <img src="images/Logo.png" alt="CapyCares Logo" class="logo-img">
            </div>
            <h1 class="logo-text">Chat with Capy</h1>
        </div>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="chat-with-capy.html">Chat with Capy</a>
            <a href="terms-conditions.html">T&C</a>
            <a href="interests.html">Interests</a>
            <a href="#" id="logoutLink" style="display: none;">Logout</a>
            <button class="dark-mode-toggle" id="darkModeToggle">
                <i class="fas fa-moon"></i>
                <span>Dark</span>
            </button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="chat-container">
        <div id="root"></div>
    </main>

    <script>
        // Check authentication first
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated
            if (!isAuthenticated()) {
                // Show auth required message and hide chat
                document.querySelector('.chat-container').innerHTML = `
                    <div style="max-width: 500px; margin: 50px auto; padding: 30px; text-align: center; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 60px; margin-bottom: 20px;">üí¨</div>
                        <h2 style="color: #333; margin-bottom: 15px;">Chat with Capy</h2>
                        <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                            Please login or signup to access the AI chat support.<br>
                            Your conversations will be saved and secured.
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <a href="student-login.html" class="btn" style="background: #fe8400; color: white; text-decoration: none; padding: 12px 25px;">
                                Student Login
                            </a>
                            <a href="student-signup.html" class="btn" style="background: #28a745; color: white; text-decoration: none; padding: 12px 25px;">
                                Student Signup
                            </a>
                        </div>
                        <div style="margin-top: 20px;">
                            <a href="index.html" style="color: #666; text-decoration: none; font-size: 14px;">
                                ‚Üê Back to Home
                            </a>
                        </div>
                    </div>
                `;
                return;
            }
            
            // User is authenticated - initialize chat normally
            initializeChatComponents();
        });
        
        function initializeChatComponents() {
            // Set up logout functionality
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.style.display = 'inline-block';
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
            
            // Load chat history
            loadChatHistory();
        }
        
        function loadChatHistory() {
            // Load chat history from localStorage
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // If there's history, update the initial messages
            if (chatHistory.length > 0) {
                // Update the initial state in the React component
                window.initialChatHistory = chatHistory;
            }
        }
        
        function saveChatMessage(message) {
            // Load existing chat history
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // Add new message with timestamp
            chatHistory.push({
                id: Date.now(),
                text: message.text,
                isUser: message.isUser,
                timestamp: new Date().toISOString(),
                flagged: message.flagged || false
            });
            
            // Keep only last 50 messages to prevent localStorage overflow
            if (chatHistory.length > 50) {
                chatHistory.splice(0, chatHistory.length - 50);
            }
            
            // Save to localStorage
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
    </script>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const axios = window.axios;
        
        function ChatWithCapy() {
          // Initialize with chat history if available
          const initialMessages = window.initialChatHistory || [
            {
              id: 1,
              text: "Hello! I'm Capy, your AI peer support bot. How can I help you today?",
              isUser: false,
              timestamp: new Date().toISOString()
            }
          ];
          
          const [question, setQuestion] = useState('');
          const [messages, setMessages] = useState(initialMessages);
          const [isLoading, setIsLoading] = useState(false);
          const messagesEndRef = useRef(null);
        
          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
          };
        
          useEffect(() => {
            scrollToBottom();
          }, [messages]);
          
          
        
          // Mental health keywords to detect
          const mentalHealthKeywords = [
            'suicidal', 'suicide', 'kill myself', 'end my life', 'want to die',
            'depressed', 'depression', 'sad', 'hopeless', 'worthless',
            'anxious', 'anxiety', 'worried', 'nervous', 'panic',
            'stress', 'stressed', 'overwhelmed', 'burned out',
            'lonely', 'isolated', 'alone', 'no one cares',
            'hurt myself', 'self harm', 'cutting'
          ];
          
          // Track repeated keywords
          const keywordCount = {};
          
          // Function to check for mental health keywords
          const checkMentalHealthKeywords = (message) => {
            const lowerMessage = message.toLowerCase();
            let flagged = false;
            
            mentalHealthKeywords.forEach(keyword => {
              if (lowerMessage.includes(keyword)) {
                flagged = true;
                keywordCount[keyword] = (keywordCount[keyword] || 0) + 1;
                
                // If keyword is repeated more than 3 times, flag for counselor
                if (keywordCount[keyword] > 3) {
                  flagForCounselor(keyword, message);
                }
              }
            });
            
            return flagged;
          };
          
          // Function to flag messages for counselor
          const flagForCounselor = async (keyword, message) => {
            // Send data to the backend
            try {
              const response = await fetch('http://localhost:5000/api/flag-message', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  sender: 'Current User',
                  keyword: keyword,
                  message: message,
                  count: keywordCount[keyword]
                })
              });
              
              const data = await response.json();
              
              if (data.success) {
                // Show notification to user
                alert(`We've noticed you're mentioning "${keyword}" frequently. A counselor has been notified and may reach out to you.`);
              }
            } catch (error) {
              console.error('Error flagging message:', error);
              // Fallback to localStorage
              const flaggedMessages = JSON.parse(localStorage.getItem('flaggedMessages') || '[]');
              
              flaggedMessages.push({
                keyword: keyword,
                message: message,
                timestamp: new Date(),
                count: keywordCount[keyword]
              });
              
              localStorage.setItem('flaggedMessages', JSON.stringify(flaggedMessages));
              
              // Show notification to user
              alert(`We've noticed you're mentioning "${keyword}" frequently. A counselor has been notified and may reach out to you.`);
            }
          };
          
          const generateAnswer = async () => {
            if (!question.trim() || isLoading) return;

            const userMessage = {
              id: Date.now(),
              text: question,
              isUser: true,
              timestamp: new Date().toISOString()
            };

            setMessages(prev => [...prev, userMessage]);
            // Save to persistent storage
            saveChatMessage(userMessage);
            setIsLoading(true);

            try {
              const res = await fetch("http://localhost:5000/api/chat", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: question })
              });

              const data = await res.json();

              const botMessage = {
                id: Date.now() + 1,
                text: data.reply,
                isUser: false,
                timestamp: new Date().toISOString()
              };

              setMessages(prev => [...prev, botMessage]);
              // Save bot response to persistent storage
              saveChatMessage(botMessage);

            } catch (err) {
              const errorMessage = {
                id: Date.now(),
                text: "Sorry, I'm having trouble responding right now.",
                isUser: false,
                isError: true,
                timestamp: new Date().toISOString()
              };
              setMessages(prev => [...prev, errorMessage]);
              saveChatMessage(errorMessage);
            }

            setIsLoading(false);
            setQuestion("");
          };


        
          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              generateAnswer();
            }
          };
        
          const quickMessage = (message) => {
            setQuestion(message);
          };
        
          return (
            <>
              {/* Chat Messages */}
              <div className="chat-messages">
                {messages.map((message) => (
                  <div 
                    key={message.id} 
                    className={`message ${message.isUser ? 'user' : ''} ${message.isError ? 'error' : ''}`}
                  >
                    <div className="message-avatar"></div>
                    <div className="message-bubble">
                      {message.text.split('\n').map((line, i) => (
                        <span key={i}>
                          {line}
                          <br />
                        </span>
                      ))}
                      {message.flagged && (
                        <div style={{color: 'red', fontSize: '12px', marginTop: '5px', fontWeight: 'bold'}}>‚ö†Ô∏è This message has been flagged for review</div>
                      )}
                      {/* Timestamp */}
                      <div style={{fontSize: '11px', color: '#888', marginTop: '5px', textAlign: 'right'}}>
                        {new Date(message.timestamp).toLocaleString('en-US', {
                          hour: '2-digit',
                          minute: '2-digit',
                          month: 'short',
                          day: 'numeric'
                        })}
                      </div>
                    </div>
                  </div>
                ))}
                {isLoading && (
                  <div className="message">
                    <div className="message-avatar"></div>
                    <div className="message-bubble">
                      <div className="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>
              
              {/* Chat Input */}
              <div className="chat-input-container">
                <div style="text-align: center; margin-bottom: 10px;">
                  <button className="btn" id="clearChatBtn" style="background: #dc3545; padding: 8px 15px; font-size: 12px;">
                    Clear Chat History
                  </button>
                </div>
                <div className="chat-input-row">
                  <input 
                    type="text" 
                    className="chat-input" 
                    placeholder="Type your message..." 
                    value={question}
                    onChange={(e) => setQuestion(e.target.value)}
                    onKeyPress={handleKeyPress}
                    disabled={isLoading}
                  />
                  <button 
                    className="btn" 
                    style={{ padding: "15px 20px", margin: "0" }}
                    onClick={generateAnswer}
                    disabled={isLoading || !question.trim()}
                  >
                    <i className="fas fa-paper-plane"></i>
                  </button>
                </div>
                
                {/* Quick Actions */}
                <div className="chat-quick-actions">
                  <button className="quick-action-btn" onClick={() => quickMessage('Need study tips')}>
                    Need study tips
                  </button>
                  <button className="quick-action-btn" onClick={() => quickMessage('Just want to talk')}>
                    Just want to talk
                  </button>
                </div>
              </div>
            </>
          );
        }

    
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatWithCapy />);
    </script>

</body>
</html>
